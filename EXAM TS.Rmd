---
title: "TS exam"
author: "Баженов Павел"
date: "2022-12-19"
output: html_document
---

```{r}
library("vars")
library("tseries")
library(TSA)
library(mlr)
library(forecast)
library(lmtest)
library(zoo)
library(xts)
library(PerformanceAnalytics)
library(ggplot2)
library(TSstudio)
library(dplyr)
library(DescTools)

#Данные содержат средние месячные продажи шампуня за 3 года. Целью данной работы является построение предсказательной модели, которая будет определять количество штук проданного шампуня за месяц, а также выделить периоды изменения продаж шампуня.
#Такое прогнозирование необходимо потому что, это помогает в общем бизнес-планировании, составлении бюджета и управлении рисками. Во-вторых, прогнозирование продаж позволяет компаниям эффективно распределять ресурсы для будущего роста и управлять своим денежным потоком.
#В-третьих, прогнозирование продаж также помогает предприятиям точно оценивать свои затраты и доходы, на основе чего они могут прогнозировать свои краткосрочные и долгосрочные результаты.

#Загрузка данных, данные помесячные за 3 года
shampoo <- read.csv("C:/Users/paul/Downloads/sales-of-shampoo-over-a-three-ye.csv")
#Создание дат для данных, в формате date
dates <- seq(as.Date("2016-01-01"), length = 36, by = "month")
smith <- xts(x = shampoo[,2], order.by = dates)
#Переделываю формат xts в ts, чтобы можно было декомпозировать на тренд и сезонность в дальнейшем
ts_smith = xts_to_ts(smith, frequency = 12, start = as.Date("2016-01-01"))
#Изобразим сам график, пока график свидетельствует лишь о наличие тренда, сезонность подтвердить на глаз нельзя
plot(ts_smith)

#Декомпозирую свой ряд и вытаскиваю график сезонности
x = decompose(ts_smith, "multiplicative")$seasonal
y = as.xts(x)
z = coredata(y)
df = cbind(z, dates)
df = as.data.frame(df)
#Изобразим график сезонности, с более частыми значениями дат
p = ggplot(aes(x = as.Date(dates), y = V1), data = df) + geom_line()
p + scale_x_date(date_labels = "%m-%Y", breaks = "month") +   theme(axis.text.x=element_text(angle=60, hjust=1)) 
#На графике сезонности видно 3 периода, в которые растёт уровень продаж шампуня: Март, лето и сентябрь - ноябрь
#Летом рост уровня продаж может быть связан с тем, что в жарку погоду люди чаще принимают душ и им нужно больше шампуня
#В период с сентября по ноябрь люди могут запасаться шампунями в период распродаж (черная пятница, предновогодняя распродажа)
#Люди чаще принимают ванну летом и, следовательно, покупают больше шампуня в это время (например, в июне, июле и августе), как показано в таблице ниже.
#Так как люди зимой меньше принимают душ, то меньше расходуется шампуня и в апреле они возврщаются в магазин, чтобы пополнить запасы, либо готовят подарки для женщин на 8 марта
#Но ещё точно нельзя сказать о наличие сезонности, декомпозиция была сделана, потому что на глаз нельзя точно сказать о сезоности


#Уберём тренд, изобразим график, выглядит стацинарно
tsap_dif <- diff(ts_smith, diff = 1)
plot(tsap_dif)
#Уберём выбросы, и проверим стационарность расширенным тестом Дики-Фулера
t1 <- tsoutliers(tsap_dif,iterate=5, lambda = NULL)
tsap_dif[t1$index]<-t1$replacements
plot(tsap_dif)

#Для теста Tau3 тестовая статистика меньше критического значения на уровне в 1%, поэтому ряд стационарен
x<-ur.df(tsap_dif, type = c("trend"), selectlags = c("Fixed"))
summary(x)
#Удостоверимся в стационарности, проведя КПСС тест. p-value >> 0.1, поэтому нулевая гипотеза не отклоняется на 10% уровне и ряд стационарен
kpss.test(tsap_dif)
#Два теста подтвердили стационарность ряда 

ggseasonplot(tsap_dif)

ggmonthplot(tsap_dif)
#По графику ACF видна сезонность данных
chart.ACFplus(tsap_dif)

#Посмотрев график box-plot, можно предположить, что есть сезонность каждые 2 или 3 месяца в ряде первых разниц
#Можно создать дамми переменные для февраля, мая, августа и октября; марта и июня; Апреля,Июля и декабря; Сентября и ноября  
#Базовым периодом становится январь. теперь стоит построить модель арима с дамми, для того, чтобы поймать сезонность
Dta<-coredata(tsap_dif)
boxplot(Dta~as.ts(cycle(tsap_dif)),xlab="Date", ylab = "Pasengers")

D<-createDummyFeatures(as.factor(cycle(tsap_dif)), cols="var")
dummies_for_tsap <- D %>% mutate(two_five_ei_te = `2`+`5`+ `8` + `10`, three_six = `3`+`6`, four_sev_twelv = `4`+`7`+`12`, nine_elev = `9`+`11`)%>% select(`1`,two_five_ei_te, three_six, four_sev_twelv, nine_elev)
eight_dum <- data.matrix(dummies_for_tsap, rownames.force = NA)

#В тренировочную выборку будут использовать данные за 2016-2017 года
train = window(tsap_dif, start = c(2016,2), end = c(2017,12))
#Чтобы не нарушить сезонность внути года в качестве тестовой выборке будет использоваться 2018 год
test <- window(tsap_dif, start = c(2018,1), end = c(2018,12))

#Создадим самую простую модель arima(1,0,1) и будем постепенно увеличивать колчиеств лагов, пока не избавимся от сезонности в остатках
arma11<-Arima(train,order=c(1,0,1),xreg=eight_dum[1:23,2:5])
coeftest(arma11)
summary(arma11)
#Взглянем на остатки
resid11 <- resid(arma11)
#к сожалению сезонность в остатка ещё осталась, поэтому надо усложнить модель
chart.ACFplus(resid11)

#Создадим  модель arima(2,0,1) и помотрим на неё
arma21<-Arima(train,order=c(2,0,1),xreg=eight_dum[1:23,2:5])
coeftest(arma21)
summary(arma21)
#Взглянем на остатки
resid21 <- resid(arma21)
#К сожалению сезонность в остатка ещё осталась, поэтому надо усложнить модель
chart.ACFplus(resid21)

#Создадим  модель arima(1,0,2) и помотрим на неё
arma12<-Arima(train,order=c(1,0,2),xreg=eight_dum[1:23,2:5])
coeftest(arma12)
summary(arma12)
#Взглянем на остатки
resid12 <- resid(arma12)
#Сезонность уже не так явно выражена, но всё равно как-будто присутствует, а т.к. я не уверен, то лучше усложню модель
chart.ACFplus(resid12)

#Создадим  модель arima(2,0,2) и помотрим на неё
arma22<-Arima(train,order=c(2,0,2),xreg=eight_dum[1:23,2:5])
coeftest(arma22)
summary(arma22)
#Взглянем на остатки
resid22 <- resid(arma22)
#К сожалению сезонность в остатка ещё осталась, поэтому надо усложнить модель
chart.ACFplus(resid22)

#Перебрав модели с лагом 3, в их остатках всё ещё оставалас сезонность.
#Построив  модель arima(2,0,4), я уверен, что в остатках нет сезонности и никакие лаги в остатках не вылезают.
arma24<-Arima(train,order=c(2,0,4),xreg=eight_dum[1:23,2:5])
summary(arma24)
resid24 <- resid(arma24)
chart.ACFplus(resid24)
#Проведя дополнительный тест на взаимную значимость остатков, где не отклоняется нулевая гипотеза, можнно сказать, что остатки WN
Box.test(resid24, lag = 10, type = c("Box-Pierce"))
#Одна из моделей, которую я буду использовать для прогноза - это модель ARIMA(2,0,4) с дамми
#Уравнение модели ARIMA(2,0,4) с дамми: Yt = m + a1*Y(t-1)+a2*Y(t-2) + et+ b1*e(t-1) + b2*e(t-2) + b3*e(t-3) + b4*e(t-4) + c1*D1t + + c2*D2t + c3*D3t + c4*D4t
#При оценке коэфициентов модели можно сделать вывод, что в феврале, мае, августе и октярбре, продают на 91 бутылку шампуня больше чем в январе.
#В марте и июне продают на 54 бутылки шампуня больше, по сравнению с продажами в январе. 
#В апреле, июле и декабре продаётся на 104 бутылки шампуня больше, чем в январе
#В сентябре и ноябре продаётся на 65 бутылок шампуня больше, чем в январе.
#Звучит вполне адекватно, что в жаркие месяцы или месяцы праздников люди покупаю значительно больше шампуня
#Только в общем получилось, что продажи предыдущего месяца снижают продажи в текущем периоде, что не очень логично, потому что тогда бы продажи упали до нуля в конченом итоге и не росли.
coeftest(arma24)



for_arima24_with_dummy<-forecast(arma24,h=length(test), level=90, xreg=eight_dum[24:35,2:5])
plot(for_arima24_with_dummy)

#Для оценки качества прогноза всех моделей будет использоваться 2 метрики качества: RMSE необходим для сравнения качества прогноза с другими моделями, но он не интерпретируется; SMAPE тоже используется для сравнения с другими моделями, но этот показатель мы можем интерпретировать
RMSE(for_arima24_with_dummy$mean,test) 
#Разделим SMAPE на 2, потому что в R SMAPE от 0 до 2, лучше интерпретируется от 0 до 1
#В среднем мы ошибаемся на 77% процентов, что достаточно много
SMAPE(for_arima24_with_dummy$mean,test)/2


#Рисуем приодограмму, период сезонности 2 месяца
P1<-periodogram(train,log='no',plot=TRUE,ylab="Periodogram", xlab="Frequency")

#Построим модель ARIMA, которая учитывает сезонность, но теперь уже с преобразованием Фурье, начнём с модели arima(1,0,1) и будем постепенно увеличивать колчиеств лагов, пока не избавимся от сезоонсти в остатках
furie11 <- Arima(train, order=c(1,0,1), xreg=fourier(train, K=6))
coeftest(furie11)
summary(furie11)
resid_f_11 <- resid(furie11)
#Присуствует сезонность, попробуем другое количество лагов
chart.ACFplus(resid_f_11)

furie12 <- Arima(train, order=c(1,0,2), xreg=fourier(train, K=6))
coeftest(furie12)
summary(furie12)
resid_f_12 <- resid(furie12)
#Присуствует сезонность, попробуем другое количество лагов
chart.ACFplus(resid_f_12)

furie21 <- Arima(train, order=c(2,0,1), xreg=fourier(train, K=6))
coeftest(furie21)
summary(furie21)
resid_f_21 <- resid(furie21)
#Присуствует сезонность, попробуем другое количество лагов
chart.ACFplus(resid_f_21)

furie22 <- Arima(train, order=c(2,0,2), xreg=fourier(train, K=6))
coeftest(furie22)
summary(furie22)
resid_f_22 <- resid(furie22)
#Присуствует сезонность, попробуем другое количество лагов
chart.ACFplus(resid_f_22)

furie14 <- Arima(train, order=c(1,0,4), xreg=fourier(train, K=6))
coeftest(furie14)
summary(furie14)
resid_f_14 <- resid(furie14)
#Похоже, что получилось избавиться от сезонности, но стоит попробовать ещё другие комбинации лагов
chart.ACFplus(resid_f_14)

furie13 <- Arima(train, order=c(1,0,3), xreg=fourier(train, K=6))
coeftest(furie13)
summary(furie13)
resid_f_13 <- resid(furie13)
#Присуствует сезонность, попробуем другое количество лагов
chart.ACFplus(resid_f_13)

furie24 <- Arima(train, order=c(2,0,4), xreg=fourier(train, K=6))
coeftest(furie24)
summary(furie24)
resid_f_24 <- resid(furie24)
#Присуствует сезонность, попробуем другое количество лагов
chart.ACFplus(resid_f_24)

furie23 <- Arima(train, order=c(2,0,3), xreg=fourier(train, K=6))
coeftest(furie23)
summary(furie23)
resid_f_23 <- resid(furie23)
#Похоже, что получилось избавиться от сезонности, но стоит попробовать ещё другие комбинации лагов
chart.ACFplus(resid_f_23)

furie33 <- Arima(train, order=c(3,0,3), xreg=fourier(train, K=6))
coeftest(furie33)
summary(furie33)
resid_f_33 <- resid(furie33)
#Сезонности нет, но мне не нравится выпирающий 3 лаг у ACF и PACF, нужно попробовать другое количество лагов
chart.ACFplus(resid_f_33)

furie34 <- Arima(train, order=c(3,0,4), xreg=fourier(train, K=6))
coeftest(furie34)
summary(furie34)
resid_f_34 <- resid(furie34)
#Сезонности нет, но мне не нравится выпирающий 3 лаг у ACF и PACF, нужно попробовать другое количество лагов
chart.ACFplus(resid_f_34)

furie25 <- Arima(train, order=c(2,0,5), xreg=fourier(train, K=6))
coeftest(furie25)
summary(furie25)
resid_f_25 <- resid(furie25)
#Сезонности нет, но мне не нравится выпирающий 3 лаг у ACF и PACF, нужно попробовать другое количество лагов
chart.ACFplus(resid_f_25)

furie44 <- Arima(train, order=c(4,0,4), xreg=fourier(train, K=6))
coeftest(furie44)
summary(furie44)
resid_f_44 <- resid(furie44)
#Сезонности нет, но мне не нравится выпирающий 3 лаг у ACF и PACF, нужно попробовать другое количество лагов
chart.ACFplus(resid_f_44)

furie45 <- Arima(train, order=c(4,0,5), xreg=fourier(train, K=6))
coeftest(furie45)
summary(furie45)
resid_f_45 <- resid(furie45)
#Сезонности нет, но мне не нравится выпирающий 3 лаг у ACF и PACF, нужно попробовать другое количество лагов
chart.ACFplus(resid_f_45)

furie55 <- Arima(train, order=c(5,0,5), xreg=fourier(train, K=6))
coeftest(furie55)
summary(furie55)
resid_f_55 <- resid(furie55)
#Похоже, что получилось избавиться от сезонности,при это ACF/PACF очень похоже на ACF/PACF лагов модели ARIMA(2,0,3)
chart.ACFplus(resid_f_55)

#В итоге удалось найти 3 модели арима с фурье, где удалось убрать сезонность в лагах: ARIMA(2,0,3), ARIMA(1,0,4) и ARIMA(5,0,5)
#Наименьший AIC и BIC у модели ARIMA(1,0,4), её и будем использовать для прогноза
#Уравнение модели ARIMA(1,0,4) с преобразованиями фурье:   Yt = m + a1*Y(t-1) + et+ b1*e(t-1) + b2*e(t-2) + b3*e(t-3) + b4*e(t-4) + [a1*cos(2Пtw1) + b1*sin(2Пtw1)]+ [a2*cos(2Пtw2) + b2*sin(2Пtw2)]+ [a3*cos(2Пtw3) + b3*sin(2Пtw3)]+ [a4*cos(2Пtw4) + b4*sin(2Пtw4)]+ [a5*cos(2Пtw5) + b5*sin(2Пtw5)]+ [a6*cos(2Пtw6) + b6*sin(2Пtw6)]
#Эта модель также говорит, что продажи прошлого месяца негативно влияют на продажи этого месяца, почему меня это смущает уже было описано выше
coeftest(furie14)
resid_f_14 <- resid(furie14)
#Похоже, что получилось избавиться от сезонности, но стоит попробовать ещё другие комбинации лагов
chart.ACFplus(resid_f_14)
#Проведя дополнительный тест на взаимную значимость остатков, где не отклоняется нулевая гипотеза, можнно сказать, что остатки WN
Box.test(resid_f_14, lag = 10, type = c("Box-Pierce"))

f_f33<-forecast(furie14,h=length(test), level=90, xreg=fourier(test, K=6, h = length(test)))
plot(f_f33)
#RMSE стало больше, но в среднем мы стале ошибаться меньше
RMSE(f_f33$mean,test) 
SMAPE(f_f33$mean,test)/2
#Дело в том, что RMSE сильно штрафует за большее отклонение в прогнозе, поэтому RMSE и больше

#Посмотрим как поведеёт себя сезонный наивный прогноз. Статистику TheilU я не считал брать, потому что эта статистика не учитывает сезонность.
fcbeer <- forecast::snaive(train, h = length(test))
plot(fcbeer)
#Сезонный наивный прогноз лучше модели с Фурье, но хуже Арима с дамми
#RMSE стало больше по сравнению с аримой с дамми, но в среднем мы стале ошибаться меньше
RMSE(fcbeer$mean,test) 
SMAPE(fcbeer$mean,test)/2


#Теперь попробуем построить модель SARIMA, начнём подбирать лаги с самой простой модели, постепенно увеличивая количество лагов
sar11_01<-Arima(train, order=c(1,0,1), seasonal=list(order = c(0,0,1), period = 6))
summary(sar11_01)
coeftest(sar11_01)
#Можно заметить сезонность в остатках, попробуем другое количество лагов
resid_sar11_01 <- resid(sar11_01)
chart.ACFplus(resid_sar11_01)

sar11_11<-Arima(train, order=c(1,0,1), seasonal=list(order = c(1,0,1), period = 6))
summary(sar11_11)
coeftest(sar11_11)
#Можно заметить сезонность в остатках, попробуем другое количество лагов
resid_sar11_11 <- resid(sar11_11)
chart.ACFplus(resid_sar11_11)

sar11_21<-Arima(train, order=c(1,0,1), seasonal=list(order = c(2,0,1), period = 6))
summary(sar11_21)
coeftest(sar11_21)
#Вроде получилось избавиться от сезонности в остатках
resid_sar11_21 <- resid(sar11_21)
chart.ACFplus(resid_sar11_21)

sar11_12<-Arima(train, order=c(1,0,1), seasonal=list(order = c(1,0,2), period = 6))
summary(sar11_12)
coeftest(sar11_12)
#Сезонность в остатка осталась, оставляем модель sARIMA(1,0,1)(2,0,1)
resid_sar11_12 <- resid(sar11_12)
chart.ACFplus(resid_sar11_12)

#Лучшей моделью SARIMA оказалась модельс порядком (1,0,1)(2,0,1)6
#Уравнение этой модели: Yt = m + a1*Y(t-1) + et+ b1*e(t-1) + C6*Y(t-6) + C5*Y(t-5) +et + d6*e(t-6)
#В этой модели получается, что продажи шампуня 3 месяца назад негативно влияют на продажи в этом месяце, звучит более логично: это может означать смену времени года
coeftest(sar11_21)

#Проведя дополнительный тест на взаимную значимость остатков, где не отклоняется нулевая гипотеза, можнно сказать, что остатки WN
Box.test(resid_sar11_21, lag = 10, type = c("Box-Pierce"))

sar_for<-forecast(sar11_21,h=length(test), level=90)
plot(sar_for)
#RMSE ниже чем, у наивного прогноза и SMAPE тоже меньше по сравнению с наивным прогнозом
RMSE(sar_for$mean,test) 
SMAPE(sar_for$mean,test)/2

#Итак, получилось, что почти все мои модели предсказывают лучшем чем модель наивного сезонного прогноза, кроме модели ARIMA с преобразованиями фурье, хотьи  наибольший средний прогноз у модели АРИМА с дамми.
#Самым лучшим образом показала себя модель SARIMA(1,0,1)(2,0,1)6 имея наименьший RMSE и SMAPE на тестовой выборке.
#При этом самая лучшая модель в плане отражения реальности оказалась модель АРИМа с дамми, т.к. она показывает, что в определённые сезоны года шампунь покупают больше, в то время как другие модели в общем говорят, что предыдущий период влияет негативно, что нелогично как по мне.
#Итак, с помощью модели АРИМА с дамми удалось выделить месяцы в которые ожидается наибольшие продажи по сравнению с другими, то есть объяснить общую картину данных. В основном это месяцы лета, либо месяцы в котороых есть праздники, зимние месяцы, в которых нет праздников обладают наименьшим уровнем продаж.
#Но для прогноза лучше всего использовать модель SARIMA (1,0,1)(2,0,1)6.
```

